<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tank Components Database</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    body {
      padding-top: 20px;
      padding-bottom: 40px;
    }
    .header {
      margin-bottom: 30px;
    }
    pre {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      max-height: 400px;
      overflow-y: auto;
    }
    .component-info {
      margin-top: 20px;
    }
    .attribute-card {
      margin-bottom: 15px;
    }
    .component-dropdown {
      max-height: 500px;
      overflow-y: auto;
    }
    .stat-label {
      font-weight: 600;
      color: #495057;
    }
    .stat-value {
      font-family: monospace;
    }
    .component-tabs {
      margin-top: 20px;
    }
    .attribute-section {
      margin-bottom: 25px;
    }
    .search-box {
      margin-bottom: 15px;
    }
    .tier-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 0.9rem;
    }
    .shell-card {
      background-color: rgba(0,0,0,.03);
      border-radius: 5px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .top-info {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    #loadingSpinner {
      display: none;
    }
    .component-selector {
      position: sticky;
      top: 0;
      z-index: 100;
      background-color: #fff;
      padding: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,.1);
      margin-bottom: 20px;
    }
    .attribute-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    .attribute-item {
      background-color: #f8f9fa;
      padding: 8px 12px;
      border-radius: 4px;
    }
    .shell-group {
      background-color: rgba(0,0,0,.02);
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    
    .shell-group h6 {
      margin-bottom: 8px;
      border-bottom: 1px solid rgba(0,0,0,.1);
      padding-bottom: 4px;
    }
    .prop-group-title {
      font-size: 1.1rem;
    }
    .counts-badge {
      font-size: 0.8rem;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="text-center">Tank Components Database</h1>
      <p class="lead text-center">Browse detailed specifications for tank components</p>
    </div>

    <div id="loadingSpinner" class="text-center my-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading component data...</p>
    </div>

    <div class="component-selector">
      <div class="row">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">Guns <span id="gunsCount" class="badge bg-light text-primary counts-badge">0</span></h5>
            </div>
            <div class="card-body p-0">
              <div class="search-box p-2">
                <input type="text" class="form-control" id="searchGuns" placeholder="Search guns...">
              </div>
              <div class="list-group component-dropdown" id="gunsList">
                <a href="#" class="list-group-item list-group-item-action disabled">Loading guns...</a>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">Turrets <span id="turretsCount" class="badge bg-light text-success counts-badge">0</span></h5>
            </div>
            <div class="card-body p-0">
              <div class="search-box p-2">
                <input type="text" class="form-control" id="searchTurrets" placeholder="Search turrets...">
              </div>
              <div class="list-group component-dropdown" id="turretsList">
                <a href="#" class="list-group-item list-group-item-action disabled">Loading turrets...</a>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">Hulls <span id="hullsCount" class="badge bg-light text-info counts-badge">0</span></h5>
            </div>
            <div class="card-body p-0">
              <div class="search-box p-2">
                <input type="text" class="form-control" id="searchHulls" placeholder="Search hulls...">
              </div>
              <div class="list-group component-dropdown" id="hullsList">
                <a href="#" class="list-group-item list-group-item-action disabled">Loading hulls...</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="component-info">
      <div id="componentDetails">
        <div class="text-center py-5">
          <i class="bi bi-arrow-up-circle fs-1 text-muted"></i>
          <h4 class="mt-3 text-muted">Select a component from above to view details</h4>
        </div>
      </div>
    </div>

    <div class="last-updated mt-3 text-muted small">
      <p id="lastUpdated">Last updated: Loading...</p>
    </div>

    <footer class="mt-5 text-center text-muted">
      <p>Tank Components Database - <a href="https://github.com/Timo3D/tanmk-components-api">GitHub Repository</a></p>
    </footer>
  </div>

  <!-- Templates -->
  <template id="gunDetailsTemplate">
    <div class="card">
      <div class="card-header">
        <div class="top-info">
          <h3 id="gunName" class="mb-0"></h3>
          <span id="gunTier" class="badge bg-primary"></span>
        </div>
        <div class="text-muted mt-2" id="gunBasicInfo"></div>
      </div>
      <div class="card-body">
        <ul class="nav nav-tabs component-tabs" id="gunTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="gun-overview-tab" data-bs-toggle="tab" data-bs-target="#gun-overview" type="button" role="tab" aria-controls="gun-overview" aria-selected="true">Overview</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="gun-shells-tab" data-bs-toggle="tab" data-bs-target="#gun-shells" type="button" role="tab" aria-controls="gun-shells" aria-selected="false">Shells</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="gun-json-tab" data-bs-toggle="tab" data-bs-target="#gun-json" type="button" role="tab" aria-controls="gun-json" aria-selected="false">Raw JSON</button>
          </li>
        </ul>
        <div class="tab-content mt-3" id="gunTabContent">
          <div class="tab-pane fade show active" id="gun-overview" role="tabpanel" aria-labelledby="gun-overview-tab">
            <div id="gunPropertyGroups">
              <!-- Property groups will be inserted here -->
            </div>
          </div>
          <div class="tab-pane fade" id="gun-shells" role="tabpanel" aria-labelledby="gun-shells-tab">
            <h5>Available Shells</h5>
            <div id="gunShells"></div>
          </div>
          <div class="tab-pane fade" id="gun-json" role="tabpanel" aria-labelledby="gun-json-tab">
            <pre id="gunRawJson"></pre>
          </div>
        </div>
      </div>
    </div>
  </template>

  <template id="turretDetailsTemplate">
    <div class="card">
      <div class="card-header">
        <div class="top-info">
          <h3 id="turretName" class="mb-0"></h3>
          <span id="turretTier" class="badge bg-success"></span>
        </div>
        <div class="text-muted mt-2" id="turretBasicInfo"></div>
      </div>
      <div class="card-body">
        <ul class="nav nav-tabs component-tabs" id="turretTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="turret-overview-tab" data-bs-toggle="tab" data-bs-target="#turret-overview" type="button" role="tab" aria-controls="turret-overview" aria-selected="true">Overview</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="turret-crew-tab" data-bs-toggle="tab" data-bs-target="#turret-crew" type="button" role="tab" aria-controls="turret-crew" aria-selected="false">Crew</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="turret-json-tab" data-bs-toggle="tab" data-bs-target="#turret-json" type="button" role="tab" aria-controls="turret-json" aria-selected="false">Raw JSON</button>
          </li>
        </ul>
        <div class="tab-content mt-3" id="turretTabContent">
          <div class="tab-pane fade show active" id="turret-overview" role="tabpanel" aria-labelledby="turret-overview-tab">
            <div id="turretPropertyGroups">
              <!-- Property groups will be inserted here -->
            </div>
          </div>
          <div class="tab-pane fade" id="turret-crew" role="tabpanel" aria-labelledby="turret-crew-tab">
            <h5>Crew Members</h5>
            <div id="turretCrew"></div>
          </div>
          <div class="tab-pane fade" id="turret-json" role="tabpanel" aria-labelledby="turret-json-tab">
            <pre id="turretRawJson"></pre>
          </div>
        </div>
      </div>
    </div>
  </template>

  <template id="hullDetailsTemplate">
    <div class="card">
      <div class="card-header">
        <div class="top-info">
          <h3 id="hullName" class="mb-0"></h3>
          <span id="hullTier" class="badge bg-info"></span>
        </div>
        <div class="text-muted mt-2" id="hullBasicInfo"></div>
      </div>
      <div class="card-body">
        <ul class="nav nav-tabs component-tabs" id="hullTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="hull-overview-tab" data-bs-toggle="tab" data-bs-target="#hull-overview" type="button" role="tab" aria-controls="hull-overview" aria-selected="true">Overview</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="hull-mobility-tab" data-bs-toggle="tab" data-bs-target="#hull-mobility" type="button" role="tab" aria-controls="hull-mobility" aria-selected="false">Mobility</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="hull-json-tab" data-bs-toggle="tab" data-bs-target="#hull-json" type="button" role="tab" aria-controls="hull-json" aria-selected="false">Raw JSON</button>
          </li>
        </ul>
        <div class="tab-content mt-3" id="hullTabContent">
          <div class="tab-pane fade show active" id="hull-overview" role="tabpanel" aria-labelledby="hull-overview-tab">
            <div id="hullPropertyGroups">
              <!-- Property groups will be inserted here -->
            </div>
          </div>
          <div class="tab-pane fade" id="hull-mobility" role="tabpanel" aria-labelledby="hull-mobility-tab">
            <h5>Mobility Characteristics</h5>
            <div id="hullMobility"></div>
          </div>
          <div class="tab-pane fade" id="hull-json" role="tabpanel" aria-labelledby="hull-json-tab">
            <pre id="hullRawJson"></pre>
          </div>
        </div>
      </div>
    </div>
  </template>

  <template id="propertyGroupTemplate">
    <div class="card mb-3">
      <div class="card-header bg-light">
        <div class="d-flex align-items-center">
          <i class="bi bi-icon me-2"></i>
          <h5 class="mb-0 prop-group-title">Group Title</h5>
        </div>
      </div>
      <div class="card-body">
        <div class="attribute-grid"></div>
      </div>
    </div>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Base URL for data files
    const DATA_BASE_URL = './data';
    
    // Component data storage
    const componentData = {
      guns: null,
      turrets: null,
      hulls: null
    };
    
    // DOM elements
    const gunsListElement = document.getElementById('gunsList');
    const turretsListElement = document.getElementById('turretsList');
    const hullsListElement = document.getElementById('hullsList');
    const componentDetailsElement = document.getElementById('componentDetails');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const lastUpdatedElement = document.getElementById('lastUpdated');

    // Counter elements
    const gunsCountElement = document.getElementById('gunsCount');
    const turretsCountElement = document.getElementById('turretsCount');
    const hullsCountElement = document.getElementById('hullsCount');
    
    // Search inputs
    const searchGunsInput = document.getElementById('searchGuns');
    const searchTurretsInput = document.getElementById('searchTurrets');
    const searchHullsInput = document.getElementById('searchHulls');
    
    // Templates
    const gunDetailsTemplate = document.getElementById('gunDetailsTemplate');
    const turretDetailsTemplate = document.getElementById('turretDetailsTemplate');
    const hullDetailsTemplate = document.getElementById('hullDetailsTemplate');
    const propertyGroupTemplate = document.getElementById('propertyGroupTemplate');
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      loadComponentData();
      
      // Set up search filters
      searchGunsInput.addEventListener('input', (e) => filterComponentList('guns', e.target.value));
      searchTurretsInput.addEventListener('input', (e) => filterComponentList('turrets', e.target.value));
      searchHullsInput.addEventListener('input', (e) => filterComponentList('hulls', e.target.value));
    });
    
    // Group properties by category
    function groupProperties(component, type) {
      // Combined properties from both attributes and config
      const allProps = {
        ...component.metadata.attributes,
        ...component.metadata.config
      };
      
      // Define property groups based on component type
      let groups = {};
      
      if (type === 'guns') {
        groups = {
          // Basic information group
          'Basic Info': {
            props: ['Rarity', 'Nation', 'Era', 'Tier', 'Dealer', 'Desc'],
            icon: 'bi-info-circle'
          },
          // Economic properties
          'Economics': {
            props: ['Yen', 'Iron', 'Steel', 'Aluminium', 'Chromium', 'Carbon_Fibre', 'Composite', 'Titanium'],
            icon: 'bi-currency-dollar'
          },
          // Gun performance properties
          'Performance': {
            props: ['GunWeight', 'Accuracy', 'RecoilZoom', 'RecoilForce', 'OverheatMult', 
                    'DamageMult', 'RecoilLength', 'ReloadTime', 'GunCaliber'],
            icon: 'bi-speedometer'
          }
        };
      } else if (type === 'turrets') {
        groups = {
          'Basic Info': {
            props: ['Rarity', 'Nation', 'Era', 'Tier', 'Dealer', 'Desc', 'Armour'],
            icon: 'bi-info-circle'
          },
          'Economics': {
            props: ['Yen', 'Iron', 'Steel', 'Aluminium', 'Chromium', 'Carbon_Fibre', 'Composite', 'Titanium'],
            icon: 'bi-currency-dollar'
          },
          'Performance': {
            props: ['TurretWeight', 'Responsiveness', 'Stabiliser', 'HzTraverse', 'VtTraverse',
                    'HzLimits', 'VtLimits', 'ReloadMultiplier', 'Range', 'RangefinderType'],
            icon: 'bi-speedometer'
          },
          'Configuration': {
            props: ['HzSound', 'VtSound', 'GunPos', 'VtPos', 'SightZoom', 'Thermals'],
            icon: 'bi-gear'
          }
        };
      } else if (type === 'hulls') {
        groups = {
          'Basic Info': {
            props: ['Rarity', 'Nation', 'Era', 'Tier', 'Dealer', 'Desc', 'Armour', 'RepairMult'],
            icon: 'bi-info-circle'
          },
          'Economics': {
            props: ['Yen', 'Iron', 'Steel', 'Aluminium', 'Chromium', 'Carbon_Fibre', 'Composite', 'Titanium'],
            icon: 'bi-currency-dollar'
          },
          'Mobility': {
            props: ['HullWeight', 'Acceleration', 'Torque', 'TurnSpeed', 'WheelFriction', 
                    'MaxSteerAngle', 'NeutralSteer', 'SpringStiffness', 'SpringDamping'],
            icon: 'bi-truck'
          },
          'Tracks & Wheels': {
            props: ['TrackWidth', 'TrackThickness', 'TrackLinkLength', 'TrackLinks', 
                    'TracksOffset', 'TracksOffsetAbs', 'Wheeled'],
            icon: 'bi-gear-wide'
          },
          'Advanced': {
            props: ['IR_Camera_Module', 'Computer_Systems', 'Radar_Module', 'Circuitry', 'Laser_Module'],
            icon: 'bi-cpu'
          }
        };
      }
      
      // Organize properties into their groups
      const groupedProps = {};
      
      // Initialize all groups (even empty ones)
      Object.keys(groups).forEach(groupName => {
        groupedProps[groupName] = [];
      });
      
      // Special handling for certain properties
      const excluded = ['CF', 'Shells', 'ForwardGears', 'ReverseGears', 'TrackColour'];
      
      // Process each property
      Object.entries(allProps).forEach(([key, value]) => {
        // Skip special properties
        if (excluded.includes(key)) return;
        
        // Check which group this property belongs to
        let assigned = false;
        
        Object.entries(groups).forEach(([groupName, groupInfo]) => {
          if (groupInfo.props.includes(key)) {
            groupedProps[groupName].push({ key, value });
            assigned = true;
          }
        });
        
        // If not assigned to any group, add to "Other" group
        if (!assigned) {
          if (!groupedProps['Other']) {
            groupedProps['Other'] = [];
          }
          groupedProps['Other'].push({ key, value });
        }
      });
      
      return { groupedProps, groups };
    }
    
   // Load component data from combined JSON file
   async function loadComponentData() {
    loadingSpinner.style.display = 'block';
    
    try {
      // Load combined components data
      const componentsResponse = await fetch(`${DATA_BASE_URL}/components.json?t=${Date.now()}`); // Add timestamp to bust cache
      if (componentsResponse.ok) {
        const data = await componentsResponse.json();
        
        // Debug: Log the structure of the loaded data
        console.log("Data structure:", {
          hasGuns: !!data.guns,
          hasTurrets: !!data.turrets,
          hasHulls: !!data.hulls,
          gunsCount: data.guns ? Object.keys(data.guns).length : 0,
          turretsCount: data.turrets ? Object.keys(data.turrets).length : 0,
          hullsCount: data.hulls ? Object.keys(data.hulls).length : 0
        });
        
        // Store the component data in our structure
        componentData.turrets = data.turrets || {};
        componentData.hulls = data.hulls || {};
        componentData.guns = data.guns || {};
        
        // Populate component lists
        populateComponentList('guns', componentData.guns);
        populateComponentList('turrets', componentData.turrets);
        populateComponentList('hulls', componentData.hulls);
        
        // Update counters
        updateCounters();
        
        // Update last updated timestamp
        if (data.lastUpdated) {
          const date = new Date(data.lastUpdated);
          lastUpdatedElement.textContent = `Last updated: ${date.toLocaleString()}`;
        }
      } else {
        throw new Error('Failed to load components data');
      }
    } catch (error) {
      console.error('Error loading component data:', error);
      alert('Error loading component data. Please check the console for details.');
      
      // Set placeholders for all lists
      setPlaceholder(gunsListElement, 'No guns data available');
      setPlaceholder(turretsListElement, 'No turrets data available');
      setPlaceholder(hullsListElement, 'No hulls data available');
    } finally {
      loadingSpinner.style.display = 'none';
    }
  }
    
    // Update component counters
    function updateCounters() {
      const gunsCount = Object.keys(componentData.guns || {}).length;
      const turretsCount = Object.keys(componentData.turrets || {}).length;
      const hullsCount = Object.keys(componentData.hulls || {}).length;
      
      gunsCountElement.textContent = gunsCount;
      turretsCountElement.textContent = turretsCount;
      hullsCountElement.textContent = hullsCount;
    }
    
    // Populate component list with data
    function populateComponentList(type, data) {
      const listElement = document.getElementById(`${type}List`);
      listElement.innerHTML = '';
      
      if (!data || Object.keys(data).length === 0) {
        setPlaceholder(listElement, `No ${type} data available`);
        return;
      }
      
      // Get all component names
      let sortedNames = Object.keys(data);
      
      // Sort components based on type
      if (type === 'guns') {
        // Sort guns by caliber (ascending), then by name
        sortedNames.sort((a, b) => {
          const caliberA = data[a].metadata?.config?.GunCaliber || 0;
          const caliberB = data[b].metadata?.config?.GunCaliber || 0;
          
          // If calibers are different, sort by caliber
          if (caliberA !== caliberB) {
            return caliberA - caliberB;
          }
          
          // If calibers are the same, sort alphabetically
          return a.localeCompare(b);
        });
      } else {
        // Sort other components alphabetically
        sortedNames.sort();
      }
      
      sortedNames.forEach(name => {
        const component = data[name];
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        
        // For guns, show caliber
        if (type === 'guns' && component.metadata.config && component.metadata.config.GunCaliber) {
          item.innerHTML = `
            ${name}
            <span class="badge bg-secondary rounded-pill">${component.metadata.config.GunCaliber}mm</span>
          `;
        } else {
          item.textContent = name;
        }
        
        item.addEventListener('click', (e) => {
          e.preventDefault();
          
          // Display component details
          displayComponentDetails(type, name, component);
        });
        
        listElement.appendChild(item);
      });
    }
    
    // Filter component list based on search input
    function filterComponentList(type, searchQuery) {
      const listElement = document.getElementById(`${type}List`);
      const items = listElement.querySelectorAll('a');
      
      const query = searchQuery.toLowerCase();
      
      items.forEach(item => {
        const name = item.textContent.trim().toLowerCase();
        if (name.includes(query)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    }
    
  // Display component details
  function displayComponentDetails(type, name, component) {
    // Clear previous content
    componentDetailsElement.innerHTML = '';
    
    // Clear active highlighting from ALL component lists
    clearAllActiveSelections();
    
    // Highlight the selected item in current list
    const listElement = document.getElementById(`${type}List`);
    const items = listElement.querySelectorAll('a');
    
    // Find the correct item to highlight
    items.forEach(item => {
      const itemText = item.textContent.trim().replace(/\d+mm$/, '').trim();
      if (itemText === name) {
        item.classList.add('active');
      }
    });
    
    // Clone the appropriate template
    let template;
    if (type === 'guns') {
      template = gunDetailsTemplate.content.cloneNode(true);
      displayGunDetails(template, name, component);
    } else if (type === 'turrets') {
      template = turretDetailsTemplate.content.cloneNode(true);
      displayTurretDetails(template, name, component);
    } else if (type === 'hulls') {
      template = hullDetailsTemplate.content.cloneNode(true);
      displayHullDetails(template, name, component);
    }
    
    componentDetailsElement.appendChild(template);
  }

// Helper function to clear all active selections
function clearAllActiveSelections() {
  // Remove active class from all lists
  document.querySelectorAll('#gunsList a, #turretsList a, #hullsList a').forEach(el => {
    el.classList.remove('active');
  });
}
    
    // Display gun details with organized property groups
    function displayGunDetails(template, name, gun) {
      // Set name and tier
      template.getElementById('gunName').textContent = name;
      
      const tier = gun.metadata.attributes?.Tier || 'Unknown';
      template.getElementById('gunTier').textContent = `Tier ${tier}`;
      
      // Set basic info
      const nation = gun.metadata.attributes?.Nation || 'Unknown Nation';
      const era = gun.metadata.attributes?.Era || 'Unknown Era';
      template.getElementById('gunBasicInfo').textContent = `${nation} • ${era} • ID: ${gun.id}`;
      
      // Group properties by category
      const { groupedProps, groups } = groupProperties(gun, 'guns');
      
      // Populate property groups
      const propertyGroupsContainer = template.getElementById('gunPropertyGroups');
      
      // Clear container
      propertyGroupsContainer.innerHTML = '';
      
      // Add each property group
      Object.entries(groupedProps).forEach(([groupName, properties]) => {
        // Skip empty groups
        if (properties.length === 0) return;
        
        // Clone the group template
        const groupElement = propertyGroupTemplate.content.cloneNode(true);
        
        // Set group title and icon
        const titleElement = groupElement.querySelector('.prop-group-title');
        titleElement.textContent = groupName;
        
        const iconElement = groupElement.querySelector('.bi');
        iconElement.className = `bi ${groups[groupName]?.icon || 'bi-three-dots'} me-2`;
        
        // Add properties to the grid
        const gridElement = groupElement.querySelector('.attribute-grid');
        
        properties.forEach(({ key, value }) => {
          const attrElement = document.createElement('div');
          attrElement.className = 'attribute-item';
          
          // Format the display value
          let displayValue = formatValue(value);
          
          attrElement.innerHTML = `
            <div class="stat-label">${formatLabel(key)}</div>
            <div class="stat-value">${displayValue}</div>
          `;
          
          gridElement.appendChild(attrElement);
        });
        
        // Add the group to the container
        propertyGroupsContainer.appendChild(groupElement);
      });
      
      // Populate shells
      const shellsContainer = template.getElementById('gunShells');
      if (gun.metadata.config && gun.metadata.config.Shells && Object.keys(gun.metadata.config.Shells).length > 0) {
        shellsContainer.innerHTML = '';
        
        Object.entries(gun.metadata.config.Shells).forEach(([shellType, shellData]) => {
          const shellCard = document.createElement('div');
          shellCard.className = 'shell-card';
          
          let shellContent = `
            <h6>${shellType} - ${shellData.ShellName || 'Unknown'}</h6>
          `;
          
          // Group shell properties
          const shellProps = {
            'Basic': ['ShellName', 'HEATFS'],
            'Ballistics': ['ShellSpeed', 'BulletGravity', 'RicochetAngle'],
            'Damage': ['Penetration', 'Penetration60', 'ExplosiveMult', 'DamageMult'],
            'Technical': ['FuseDelay', 'FuseSensitivity']
          };
          
          // Organize shell properties by group
          const organizedProps = {};
          Object.entries(shellProps).forEach(([group, propList]) => {
            organizedProps[group] = [];
            propList.forEach(prop => {
              if (shellData[prop] !== undefined) {
                organizedProps[group].push({ key: prop, value: shellData[prop] });
              }
            });
          });
          
          // Add other properties that weren't categorized
          const categorizedProps = Object.values(shellProps).flat();
          const otherProps = Object.entries(shellData)
            .filter(([key]) => !categorizedProps.includes(key))
            .map(([key, value]) => ({ key, value }));
          
          if (otherProps.length > 0) {
            organizedProps['Other'] = otherProps;
          }
          
          // Add shell properties by group
          Object.entries(organizedProps).forEach(([group, props]) => {
            if (props.length === 0) return;
            
            shellContent += `<div class="shell-group mb-2"><h6 class="small text-muted">${group}</h6><div class="attribute-grid">`;
            
            props.forEach(({ key, value }) => {
              shellContent += `
                <div class="attribute-item">
                  <div class="stat-label">${formatLabel(key)}</div>
                  <div class="stat-value">${formatValue(value)}</div>
                </div>
              `;
            });
            
            shellContent += '</div></div>';
          });
          
          shellCard.innerHTML = shellContent;
          shellsContainer.appendChild(shellCard);
        });
      } else {
        shellsContainer.innerHTML = '<p class="text-muted">No shell data available</p>';
      }
      
      // Set raw JSON
      template.getElementById('gunRawJson').textContent = JSON.stringify(gun, null, 2);
    }
    
    // Display turret details with organized property groups
    function displayTurretDetails(template, name, turret) {
      // Set name and tier
      template.getElementById('turretName').textContent = name;
      
      const tier = turret.metadata.attributes?.Tier || 'Unknown';
      template.getElementById('turretTier').textContent = `Tier ${tier}`;
      
      // Set basic info
      const nation = turret.metadata.attributes?.Nation || 'Unknown Nation';
      const era = turret.metadata.attributes?.Era || 'Unknown Era';
      template.getElementById('turretBasicInfo').textContent = `${nation} • ${era} • ID: ${turret.id}`;
      
      // Group properties by category
      const { groupedProps, groups } = groupProperties(turret, 'turrets');
      
      // Populate property groups
      const propertyGroupsContainer = template.getElementById('turretPropertyGroups');
      
      // Clear container
      propertyGroupsContainer.innerHTML = '';
      
      // Add each property group
      Object.entries(groupedProps).forEach(([groupName, properties]) => {
        // Skip empty groups
        if (properties.length === 0) return;
        
        // Clone the group template
        const groupElement = propertyGroupTemplate.content.cloneNode(true);
        
        // Set group title and icon
        const titleElement = groupElement.querySelector('.prop-group-title');
        titleElement.textContent = groupName;
        
        const iconElement = groupElement.querySelector('.bi');
        iconElement.className = `bi ${groups[groupName]?.icon || 'bi-three-dots'} me-2`;
        
        // Add properties to the grid
        const gridElement = groupElement.querySelector('.attribute-grid');
        
        properties.forEach(({ key, value }) => {
          const attrElement = document.createElement('div');
          attrElement.className = 'attribute-item';
          
          // Format the display value
          let displayValue = formatValue(value);
          
          attrElement.innerHTML = `
            <div class="stat-label">${formatLabel(key)}</div>
            <div class="stat-value">${displayValue}</div>
          `;
          
          gridElement.appendChild(attrElement);
        });
        
        // Add the group to the container
        propertyGroupsContainer.appendChild(groupElement);
      });
      
      // Populate crew
      const crewContainer = template.getElementById('turretCrew');
      if (turret.metadata.crew && turret.metadata.crew.length > 0) {
        const crewList = document.createElement('ul');
        crewList.className = 'list-group';
        
        turret.metadata.crew.forEach(crewMember => {
          const item = document.createElement('li');
          item.className = 'list-group-item';
          item.textContent = crewMember;
          crewList.appendChild(item);
        });
        
        crewContainer.appendChild(crewList);
      } else {
        crewContainer.innerHTML = '<p class="text-muted">No crew data available</p>';
      }
      
      // Set raw JSON
      template.getElementById('turretRawJson').textContent = JSON.stringify(turret, null, 2);
    }
    
    // Display hull details with organized property groups
    function displayHullDetails(template, name, hull) {
      // Set name and tier
      template.getElementById('hullName').textContent = name;
      
      const tier = hull.metadata.attributes?.Tier || 'Unknown';
      template.getElementById('hullTier').textContent = `Tier ${tier}`;
      
      // Set basic info
      const nation = hull.metadata.attributes?.Nation || 'Unknown Nation';
      const era = hull.metadata.attributes?.Era || 'Unknown Era';
      template.getElementById('hullBasicInfo').textContent = `${nation} • ${era} • ID: ${hull.id}`;
      
      // Group properties by category
      const { groupedProps, groups } = groupProperties(hull, 'hulls');
      
      // Populate property groups
      const propertyGroupsContainer = template.getElementById('hullPropertyGroups');
      
      // Clear container
      propertyGroupsContainer.innerHTML = '';
      
      // Add each property group
      Object.entries(groupedProps).forEach(([groupName, properties]) => {
        // Skip empty groups
        if (properties.length === 0) return;
        
        // Skip 'Mobility' as it has its own tab
        if (groupName === 'Mobility' || groupName === 'Tracks & Wheels') return;
        
        // Clone the group template
        const groupElement = propertyGroupTemplate.content.cloneNode(true);
        
        // Set group title and icon
        const titleElement = groupElement.querySelector('.prop-group-title');
        titleElement.textContent = groupName;
        
        const iconElement = groupElement.querySelector('.bi');
        iconElement.className = `bi ${groups[groupName]?.icon || 'bi-three-dots'} me-2`;
        
        // Add properties to the grid
        const gridElement = groupElement.querySelector('.attribute-grid');
        
        properties.forEach(({ key, value }) => {
          const attrElement = document.createElement('div');
          attrElement.className = 'attribute-item';
          
          // Format the display value
          let displayValue = formatValue(value);
          
          attrElement.innerHTML = `
            <div class="stat-label">${formatLabel(key)}</div>
            <div class="stat-value">${displayValue}</div>
          `;
          
          gridElement.appendChild(attrElement);
        });
        
        // Add the group to the container
        propertyGroupsContainer.appendChild(groupElement);
      });
      
      // Populate mobility details
      const mobilityContainer = template.getElementById('hullMobility');
      
      // Clear container
      mobilityContainer.innerHTML = '';
      
      if (hull.metadata.config) {
        // Use the Mobility group properties directly
        const mobilityProps = groupedProps['Mobility'] || [];
        
        if (mobilityProps.length > 0) {
          const mobilityCard = document.createElement('div');
          mobilityCard.className = 'card mb-3';
          
          mobilityCard.innerHTML = `
            <div class="card-header">
              <div class="d-flex align-items-center">
                <i class="bi bi-truck me-2"></i>
                <h5 class="mb-0">Performance Parameters</h5>
              </div>
            </div>
            <div class="card-body">
              <div class="attribute-grid"></div>
            </div>
          `;
          
          const gridElement = mobilityCard.querySelector('.attribute-grid');
          
          mobilityProps.forEach(({ key, value }) => {
            const attrElement = document.createElement('div');
            attrElement.className = 'attribute-item';
            
            attrElement.innerHTML = `
              <div class="stat-label">${formatLabel(key)}</div>
              <div class="stat-value">${formatValue(value)}</div>
            `;
            
            gridElement.appendChild(attrElement);
          });
          
          mobilityContainer.appendChild(mobilityCard);
        }
        
        // Add gears section if available
        if (hull.metadata.config.ForwardGears || hull.metadata.config.ReverseGears) {
          const gearsCard = document.createElement('div');
          gearsCard.className = 'card mb-3';
          
          let gearsContent = `
            <div class="card-header">
              <div class="d-flex align-items-center">
                <i class="bi bi-gear me-2"></i>
                <h5 class="mb-0">Transmission</h5>
              </div>
            </div>
            <div class="card-body">
              <div class="row">
          `;
          
          if (hull.metadata.config.ForwardGears) {
            gearsContent += `
              <div class="col-md-6">
                <h6>Forward Gears</h6>
                <p class="mb-0">${hull.metadata.config.ForwardGears}</p>
              </div>
            `;
          }
          
          if (hull.metadata.config.ReverseGears) {
            gearsContent += `
              <div class="col-md-6">
                <h6>Reverse Gears</h6>
                <p class="mb-0">${hull.metadata.config.ReverseGears}</p>
              </div>
            `;
          }
          
          gearsContent += `
              </div>
            </div>
          `;
          
          gearsCard.innerHTML = gearsContent;
          mobilityContainer.appendChild(gearsCard);
        }
        
        // Add track details if available
        const trackProps = groupedProps['Tracks & Wheels'] || [];
        
        if (trackProps.length > 0) {
          const trackCard = document.createElement('div');
          trackCard.className = 'card mb-3';
          
          trackCard.innerHTML = `
            <div class="card-header">
              <div class="d-flex align-items-center">
                <i class="bi bi-gear-wide me-2"></i>
                <h5 class="mb-0">Tracks & Wheels</h5>
              </div>
            </div>
            <div class="card-body">
              <div class="attribute-grid"></div>
            </div>
          `;
          
          const gridElement = trackCard.querySelector('.attribute-grid');
          
          trackProps.forEach(({ key, value }) => {
            const attrElement = document.createElement('div');
            attrElement.className = 'attribute-item';
            
            attrElement.innerHTML = `
              <div class="stat-label">${formatLabel(key)}</div>
              <div class="stat-value">${formatValue(value)}</div>
            `;
            
            gridElement.appendChild(attrElement);
          });
          
          mobilityContainer.appendChild(trackCard);
        }
      } else {
        mobilityContainer.innerHTML = '<p class="text-muted">No mobility data available</p>';
      }
      
      // Set raw JSON
      template.getElementById('hullRawJson').textContent = JSON.stringify(hull, null, 2);
    }
    
    // Format a value based on its type
    function formatValue(value) {
      if (value === null || value === undefined) {
        return '-';
      }
      
      if (typeof value === 'boolean') {
        return value ? 'Yes' : 'No';
      }
      
      if (typeof value === 'object') {
        // Handle special object types like Vector3, Vector2, Color3
        if (value.type === 'Vector3' || value.type === 'Vector2') {
          return value.values.map(v => v.toFixed(2)).join(', ');
        }
        
        if (value.type === 'Color3') {
          return `RGB(${value.values.map(v => Math.round(v * 255)).join(', ')})`;
        }
        
        // For position/orientation arrays
        if (Array.isArray(value)) {
          return value.map(v => typeof v === 'number' ? v.toFixed(2) : v).join(', ');
        }
        
        // For other objects, stringify
        return JSON.stringify(value);
      }
      
      // Format numbers
      if (typeof value === 'number') {
        return Number.isInteger(value) ? value : value.toFixed(2);
      }
      
      return value;
    }
    
    // Format a label from camelCase or snake_case to Title Case with spaces
    function formatLabel(label) {
      // Replace camelCase with spaces
      label = label.replace(/([A-Z])/g, ' $1');
      // Replace snake_case with spaces
      label = label.replace(/_/g, ' ');
      // Title case
      label = label.charAt(0).toUpperCase() + label.slice(1);
      return label;
    }
    
    // Set placeholder text in a list element
    function setPlaceholder(element, text) {
      element.innerHTML = `<a href="#" class="list-group-item list-group-item-action disabled">${text}</a>`;
    }
  </script>
</body>
</html>